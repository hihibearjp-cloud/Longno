import React, { useState, useEffect } from 'react';
import { BookOpen, Camera, CreditCard, Plus, Trash2, MapPin, Coffee, Train, Calendar, ChevronRight, Home, Snowflake, Utensils } from 'lucide-react';

// --- æ¨¡æ“¬è³‡æ–™èˆ‡æ”»ç•¥å…§å®¹ (ä¾†è‡ª PDF) ---
const GUIDE_DATA = {
  transport: {
    title: "äº¤é€šé€ŸæŸ¥",
    items: [
      { label: "æ±äº¬ â†’ é•·é‡", desc: "åŒ—é™¸æ–°å¹¹ç·š (ç´„1.5å°æ™‚)", price: 8500 },
      { label: "é•·é‡ç«™ â†’ æˆ¶éš±ä¸­ç¤¾", desc: "é•·é›»å·´å£« 70/73ç³» (7è™Ÿæœˆå°)", price: 1400 },
    ],
    busSchedule: {
      outbound: ["07:00", "08:00", "09:00", "10:00"],
      inbound: ["13:00", "14:00", "15:00", "16:00"]
    }
  },
  itinerary: [
    {
      day: "Day 1",
      title: "æˆ¶éš±ç¥ç¤¾èˆ‡ç¥æœ¨",
      spots: ["é•·é‡ç«™å‡ºç™¼", "æˆ¶éš±ä¸­ç¤¾", "å¤æ‰åƒé“ (é›ªæ™¯)", "åˆé¤ï¼šæˆ¶éš±æ‰‹æ‰“è•éº¥éºµ (Gokui)"],
      note: "æ³¨æ„ï¼šå†¬å­£è‹¥æš´é›ªï¼Œé“è·¯å¯èƒ½è‡¨æ™‚å°é–‰ã€‚"
    },
    {
      day: "Day 2",
      title: "å–„å…‰å¯ºèˆ‡è€è¡—ç¾é£Ÿ",
      spots: ["å–„å…‰å¯º (æ¸…æ™¨åƒæ‹œ)", "BENI-BENI è˜‹æœæ´¾", "å‘³å™Œå±‹æ‹‰éºµ (è»Šç«™æ—)"],
      note: "å¿…é»ï¼šç†±è˜‹æœæ´¾ï¼Œé…¸ç”œçˆ†æ±ï¼Œé•·é‡é™å®šï¼"
    },
    {
      day: "Day 3",
      title: "é›ªçŒ´èˆ‡æº«æ³‰ (é€²éš)",
      spots: ["åœ°ç„è°·é‡çŒ¿å…¬è‹‘", "å°å¸ƒæ–½ç”º (æ —å­ç”œé»)", "æ¹¯ç”°ä¸­æº«æ³‰é„‰"],
      note: "é©åˆäºŒåˆ·æˆ–æ˜¯æ™‚é–“å……è£•çš„æ—…äººã€‚"
    }
  ],
  accommodation: ["Dormy Inn é•·é‡æº«æ³‰é£¯åº— (å«å®µå¤œ)", "é•·é‡å¤§éƒ½æœƒé£¯åº— (ç›´é€šè»Šç«™)"]
};

// --- å…ƒä»¶ï¼šå¡ç‰‡å®¹å™¨ ---
const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden ${className}`}>
    {children}
  </div>
);

// --- é é¢ï¼šæ”»ç•¥ (Guide) ---
const GuideView = () => (
  <div className="space-y-6 pb-20">
    {/* æ­¡è¿æ©«å¹… */}
    <div className="relative h-40 bg-gradient-to-r from-slate-800 to-slate-600 rounded-2xl overflow-hidden flex items-center justify-center text-white shadow-md mx-4 mt-4">
      <div className="absolute inset-0 opacity-20 bg-[url('[https://www.transparenttextures.com/patterns/snow.png](https://www.transparenttextures.com/patterns/snow.png)')]"></div>
      <div className="text-center z-10">
        <h2 className="text-2xl font-bold tracking-widest mb-1">é•·é‡ NAGANO</h2>
        <p className="text-sm opacity-90">é›ªã€ç¥ç¤¾èˆ‡è˜‹æœæ´¾çš„é¦™æ°£</p>
      </div>
    </div>

    {/* äº¤é€šè³‡è¨Š */}
    <div className="px-4">
      <h3 className="text-lg font-bold text-slate-800 mb-3 flex items-center gap-2">
        <Train className="w-5 h-5 text-red-500" /> äº¤é€šé€ŸæŸ¥
      </h3>
      <Card>
        <div className="p-4 space-y-4">
          {GUIDE_DATA.transport.items.map((item, idx) => (
            <div key={idx} className="flex justify-between items-start border-b border-slate-100 last:border-0 pb-3 last:pb-0">
              <div>
                <div className="font-semibold text-slate-700">{item.label}</div>
                <div className="text-xs text-slate-500">{item.desc}</div>
              </div>
              <div className="text-sm font-bold text-slate-600">Â¥{item.price.toLocaleString()}</div>
            </div>
          ))}
          
          <div className="bg-slate-50 p-3 rounded-lg">
            <div className="text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">æˆ¶éš±å·´å£«æ™‚åˆ»è¡¨ (å†¬å­£åƒè€ƒ)</div>
            <div className="grid grid-cols-2 gap-4 text-sm">
              <div>
                <span className="block text-red-500 font-bold text-xs mb-1">å»ç¨‹ (é•·é‡ç«™ç™¼)</span>
                <div className="font-mono text-slate-700">{GUIDE_DATA.transport.busSchedule.outbound.join(" / ")}</div>
              </div>
              <div>
                <span className="block text-blue-500 font-bold text-xs mb-1">å›ç¨‹ (ä¸­ç¤¾ç™¼)</span>
                <div className="font-mono text-slate-700">{GUIDE_DATA.transport.busSchedule.inbound.join(" / ")}</div>
              </div>
            </div>
          </div>
        </div>
      </Card>
    </div>

    {/* è¡Œç¨‹å»ºè­° */}
    <div className="px-4">
      <h3 className="text-lg font-bold text-slate-800 mb-3 flex items-center gap-2">
        <MapPin className="w-5 h-5 text-red-500" /> ç²¾è¯è¡Œç¨‹
      </h3>
      <div className="space-y-4">
        {GUIDE_DATA.itinerary.map((day, idx) => (
          <Card key={idx}>
            <div className="p-4">
              <div className="flex items-center justify-between mb-3">
                <span className="bg-red-50 text-red-600 px-2 py-1 rounded text-xs font-bold">{day.day}</span>
                <h4 className="font-bold text-slate-800">{day.title}</h4>
              </div>
              <ul className="space-y-2 mb-3">
                {day.spots.map((spot, sIdx) => (
                  <li key={sIdx} className="flex items-start gap-2 text-sm text-slate-600">
                    <div className="mt-1.5 w-1.5 h-1.5 rounded-full bg-slate-300 shrink-0"></div>
                    {spot}
                  </li>
                ))}
              </ul>
              {day.note && (
                <div className="text-xs text-amber-600 bg-amber-50 p-2 rounded border border-amber-100">
                  ğŸ’¡ {day.note}
                </div>
              )}
            </div>
          </Card>
        ))}
      </div>
    </div>
    
    <div className="h-4"></div>
  </div>
);

// --- é é¢ï¼šè¨˜å¸³ (Expenses) ---
const ExpensesView = ({ expenses, setExpenses }) => {
  const [newItem, setNewItem] = useState("");
  const [newCost, setNewCost] = useState("");
  const [category, setCategory] = useState("é£Ÿ");

  const categories = {
    "é£Ÿ": { icon: <Utensils className="w-4 h-4" />, color: "bg-orange-100 text-orange-600" },
    "è¡Œ": { icon: <Train className="w-4 h-4" />, color: "bg-blue-100 text-blue-600" },
    "ä½": { icon: <Home className="w-4 h-4" />, color: "bg-purple-100 text-purple-600" },
    "è²·": { icon: <CreditCard className="w-4 h-4" />, color: "bg-green-100 text-green-600" },
  };

  const handleAdd = () => {
    if (!newItem || !newCost) return;
    const expense = {
      id: Date.now(),
      item: newItem,
      cost: parseInt(newCost),
      category,
      date: new Date().toLocaleDateString()
    };
    setExpenses([expense, ...expenses]);
    setNewItem("");
    setNewCost("");
  };

  const handleDelete = (id) => {
    setExpenses(expenses.filter(e => e.id !== id));
  };

  const totalCost = expenses.reduce((acc, curr) => acc + curr.cost, 0);

  return (
    <div className="space-y-6 px-4 pt-4 pb-24">
      {/* ç¸½é‡‘é¡å¡ç‰‡ */}
      <div className="bg-slate-800 text-white rounded-2xl p-6 shadow-lg">
        <div className="text-slate-400 text-sm mb-1">æ—…è²»ç¸½è¨ˆ (JPY)</div>
        <div className="text-4xl font-bold font-mono">Â¥{totalCost.toLocaleString()}</div>
        <div className="mt-2 text-xs text-slate-400 flex items-center gap-1">
          <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
          ç´„ {(totalCost * 0.21).toLocaleString()} TWD (åŒ¯ç‡åƒè€ƒ)
        </div>
      </div>

      {/* æ–°å¢æ¶ˆè²» */}
      <Card>
        <div className="p-4">
          <div className="text-sm font-bold text-slate-700 mb-3">æ–°å¢ä¸€ç­†</div>
          <div className="flex gap-2 mb-3">
            {Object.keys(categories).map(cat => (
              <button
                key={cat}
                onClick={() => setCategory(cat)}
                className={`flex-1 py-2 rounded-lg text-sm font-medium transition-colors ${
                  category === cat ? 'bg-slate-800 text-white shadow' : 'bg-slate-100 text-slate-500'
                }`}
              >
                {cat}
              </button>
            ))}
          </div>
          <div className="flex gap-2 mb-3">
            <input
              type="text"
              placeholder="é …ç›® (å¦‚: è˜‹æœæ´¾)"
              value={newItem}
              onChange={(e) => setNewItem(e.target.value)}
              className="flex-1 p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-slate-400"
            />
            <input
              type="number"
              placeholder="é‡‘é¡"
              value={newCost}
              onChange={(e) => setNewCost(e.target.value)}
              className="w-24 p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-slate-400"
            />
          </div>
          <button
            onClick={handleAdd}
            className="w-full bg-red-500 hover:bg-red-600 active:bg-red-700 text-white py-2.5 rounded-lg font-bold text-sm shadow-sm transition-colors flex items-center justify-center gap-2"
          >
            <Plus className="w-4 h-4" /> è¨˜ä¸€ç­†
          </button>
        </div>
      </Card>

      {/* æ¶ˆè²»åˆ—è¡¨ */}
      <div>
        <h3 className="text-sm font-bold text-slate-500 mb-2 uppercase tracking-wider">æ¶ˆè²»æ˜ç´°</h3>
        <div className="space-y-2">
          {expenses.length === 0 ? (
            <div className="text-center py-8 text-slate-400 text-sm">é‚„æ²’æœ‰ç´€éŒ„ï¼Œè²·å€‹è˜‹æœæ´¾å§ï¼Ÿ</div>
          ) : (
            expenses.map((exp) => (
              <div key={exp.id} className="bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className={`w-8 h-8 rounded-full flex items-center justify-center ${categories[exp.category].color}`}>
                    {categories[exp.category].icon}
                  </div>
                  <div>
                    <div className="font-medium text-slate-800">{exp.item}</div>
                    <div className="text-xs text-slate-400">{exp.date}</div>
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <span className="font-mono font-bold text-slate-700">Â¥{exp.cost.toLocaleString()}</span>
                  <button onClick={() => handleDelete(exp.id)} className="text-slate-300 hover:text-red-400">
                    <Trash2 className="w-4 h-4" />
                  </button>
                </div>
              </div>
            ))
          )}
        </div>
      </div>
    </div>
  );
};

// --- é é¢ï¼šæ—¥è¨˜ (Journal) ---
const JournalView = ({ entries, setEntries }) => {
  const [text, setText] = useState("");
  
  const handlePost = () => {
    if (!text) return;
    const entry = {
      id: Date.now(),
      text,
      date: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
      fullDate: new Date().toLocaleDateString()
    };
    setEntries([entry, ...entries]);
    setText("");
  };

  return (
    <div className="space-y-6 px-4 pt-4 pb-24 h-full flex flex-col">
      {/* è¼¸å…¥å€ */}
      <Card>
        <div className="p-4">
          <textarea
            className="w-full h-24 resize-none bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm focus:outline-none focus:border-slate-400 mb-3"
            placeholder="æ­¤åˆ»çš„å¿ƒæƒ…ã€å¤©æ°£æˆ–æ˜¯å‰›åƒåˆ°çš„ç¾é£Ÿ..."
            value={text}
            onChange={(e) => setText(e.target.value)}
          ></textarea>
          <div className="flex justify-between items-center">
             <button className="text-slate-400 hover:text-slate-600">
                <Camera className="w-5 h-5" />
             </button>
             <button
              onClick={handlePost}
              className="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-700"
             >
               ç™¼ä½ˆæ—¥è¨˜
             </button>
          </div>
        </div>
      </Card>

      {/* æ™‚é–“è»¸åˆ—è¡¨ */}
      <div className="flex-1 overflow-y-auto">
        {entries.length === 0 ? (
          <div className="flex flex-col items-center justify-center py-12 text-slate-400">
            <Snowflake className="w-12 h-12 mb-2 opacity-20" />
            <p className="text-sm">é•·é‡çš„é›ªæ™¯å¾ˆç¾ï¼Œå¯«ä¸‹ä¾†å§</p>
          </div>
        ) : (
          <div className="space-y-4 relative pl-4 border-l-2 border-slate-100 ml-2">
            {entries.map((entry) => (
              <div key={entry.id} className="relative">
                {/* è£é£¾åœ“é» */}
                <div className="absolute -left-[21px] top-3 w-3 h-3 bg-red-400 rounded-full border-2 border-white shadow-sm"></div>
                <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                  <div className="text-xs font-bold text-slate-400 mb-1 flex justify-between">
                    <span>{entry.fullDate}</span>
                    <span>{entry.date}</span>
                  </div>
                  <p className="text-slate-700 text-sm whitespace-pre-wrap leading-relaxed">{entry.text}</p>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

// --- ä¸»ç¨‹å¼ ---
export default function App() {
  const [activeTab, setActiveTab] = useState("guide");
  
  // ç‹€æ…‹ç®¡ç† (å« localStorage æŒä¹…åŒ–)
  const [expenses, setExpenses] = useState(() => {
    const saved = localStorage.getItem("nagano_expenses");
    // é è¨­è³‡æ–™ï¼šæ”¾å…¥æ”»ç•¥ä¸­æåˆ°çš„åŸºæœ¬é–‹éŠ·
    return saved ? JSON.parse(saved) : [
      { id: 1, item: "æ±äº¬-é•·é‡ æ–°å¹¹ç·š", cost: 8500, category: "è¡Œ", date: "é ç®—" },
      { id: 2, item: "å¾€æˆ¶éš±å·´å£«", cost: 1400, category: "è¡Œ", date: "é ç®—" },
    ];
  });

  const [journalEntries, setJournalEntries] = useState(() => {
    const saved = localStorage.getItem("nagano_journal");
    return saved ? JSON.parse(saved) : [];
  });

  useEffect(() => {
    localStorage.setItem("nagano_expenses", JSON.stringify(expenses));
  }, [expenses]);

  useEffect(() => {
    localStorage.setItem("nagano_journal", JSON.stringify(journalEntries));
  }, [journalEntries]);

  // åº•éƒ¨å°èˆªæ¬„è¨­å®š
  const tabs = [
    { id: "guide", label: "æ”»ç•¥", icon: <BookOpen className="w-5 h-5" /> },
    { id: "expenses", label: "è¨˜å¸³", icon: <CreditCard className="w-5 h-5" /> },
    { id: "journal", label: "æ—¥è¨˜", icon: <Calendar className="w-5 h-5" /> },
  ];

  return (
    <div className="w-full h-screen bg-slate-50 font-sans text-slate-900 flex flex-col max-w-md mx-auto relative shadow-2xl overflow-hidden">
      
      {/* é ‚éƒ¨å°èˆª */}
      <header className="bg-white border-b border-slate-100 p-4 sticky top-0 z-10 flex items-center justify-between">
        <h1 className="text-lg font-bold flex items-center gap-2">
          <span className="bg-red-500 text-white w-7 h-7 flex items-center justify-center rounded-lg text-xs">é•·</span>
          é•·é‡æ—…äººæ‰‹å¸³
        </h1>
        <div className="text-xs text-slate-400 font-mono">2025 Winter</div>
      </header>

      {/* ä¸»è¦å…§å®¹å€ (å¯æ²å‹•) */}
      <main className="flex-1 overflow-y-auto scrollbar-hide">
        {activeTab === "guide" && <GuideView />}
        {activeTab === "expenses" && <ExpensesView expenses={expenses} setExpenses={setExpenses} />}
        {activeTab === "journal" && <JournalView entries={journalEntries} setEntries={setJournalEntries} />}
      </main>

      {/* åº•éƒ¨ Tab Bar */}
      <nav className="bg-white border-t border-slate-100 pb-safe pt-2 px-6 absolute bottom-0 w-full z-20">
        <div className="flex justify-between items-center h-14">
          {tabs.map((tab) => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`flex flex-col items-center gap-1 transition-all w-16 ${
                activeTab === tab.id 
                  ? "text-red-500 scale-105" 
                  : "text-slate-400 hover:text-slate-600"
              }`}
            >
              {tab.icon}
              <span className="text-[10px] font-bold">{tab.label}</span>
            </button>
          ))}
        </div>
      </nav>
      
      <style>{`
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
      `}</style>
    </div>
  );
}
